<div *ngIf="!notFound else notFoundMessage">
  <div class="section name-section">
    <div class="required-field">
      <ng-container [ngSwitch]="mode">
        <div *ngSwitchCase="Mode.Create">
          <h2 class="page-header">Create a new Workspace</h2>
        </div>
        <div *ngSwitchCase="Mode.Edit">
          <h2 class="page-header">Edit workspace "{{workspace.name}}"</h2>
        </div>
        <div *ngSwitchCase="Mode.Clone">
          <h2 class="page-header">Duplicate workspace "{{oldWorkspaceName}}"</h2>
        </div>
      </ng-container>
      <div class="required-text">(Required)</div>
      <app-tooltip>
        <div class="tooltip-label">
          A Workspace is your place to store and analyze data for a specific project. Each Workspace is a separate
          Google bucket that serves as a dedicated space for file storage. You can share this Workspace with other
          users,
          allowing them to view or edit your work. Your Workspace is where you will go to build concept sets and cohorts
          and launch Notebooks for performing analyses on your cohorts.
        </div>
      </app-tooltip>
    </div>
    <div class="name-area required-field" [class.validation-error]="nameNotEntered"
          style="display: inline-block; vertical-align: middle;">
      <input type="text" class="input name" name="workspace-name" autofocus
             [(ngModel)]="workspace.name" [disabled]="!hasPermission"
             placeholder="Workspace Name">
    </div>
    <clr-dropdown style="display: inline-block; vertical-align: middle;">
      <div class="tooltip">
        <div class="tooltip-content-wrapper">
          <button [disabled]="mode == Mode.Edit"
                  class="btn btn-dropdown cdr-version-dropdown" type="button" clrDropdownTrigger>
            {{selectedCdrName}}
            <clr-icon shape="caret down"></clr-icon>
          </button>
          <div *ngIf="mode == Mode.Edit" class="tooltip-text">
            To use a different dataset version, clone or create a new workspace.
          </div>
        </div>
      </div>
      <clr-dropdown-menu *clrIfOpen style="width: 11rem;">
        <ng-container *ngFor="let version of cdrVersions">
          <button type="button" clrDropdownItem class="cdr-version-item"
                  [class.active]="workspace.cdrVersionId === version.cdrVersionId"
                  (click)="workspace.cdrVersionId = version.cdrVersionId">
            {{version.name}}
          </button>
        </ng-container>
      </clr-dropdown-menu>
    </clr-dropdown>
    <app-tooltip>
      <div class="tooltip-label">
        The curated data repository (CDR) is where research data from the All of Us Research Program is stored.
        The CDR is periodically updated as new data becomes available for use.
        You can select which version of the CDR you wish to query in this Workspace.
      </div>
    </app-tooltip>
    <div *ngIf="mode == Mode.Clone" class="clone-collab"
         style="display: inline-block; vertical-align: middle;">
      <clr-checkbox
        name="clone-user-roles"
        id="clone-user-roles"
        style="display: inline-block; vertical-align: top;"
        [(ngModel)]="cloneUserRoles">
      </clr-checkbox>
      <div style="display: inline-block;">
        <label class="checkbox-label" for="clr-checkbox-clone-user-roles">
          <h3 class="section-header">Copy original workspace collaborators</h3>
          <span class="section-text">Share cloned workspace with same collaborators</span>
        </label>
      </div>
    </div>
  </div>
  <div>

    <div class="section billing-project-section">
      <div class="section-header">
        Billing Account
        <app-tooltip>
          <div class="tooltip-label">
            Throughout this period of testing and development, your use of the Workbench is being funded by the National Institutes of Health.
            In the future researchers may be required to enter billing account information to cover the cost of computing time in the cloud.
          </div>
        </app-tooltip>
      </div>
      <div class="section-sub-header">
        National Institutes of Health
      </div>
      <div class="section-text">
        To fulfill program requirements, All of Us requests the following information
        for each workspace.
        <div *ngIf="!hideDetailsLaterOption">
          If you are not ready to complete this questionnaire,
          or if this is a temporary workspace, please check this box (any entries already made will not be saved):
        </div>
      </div>
      <div class="section-text" *ngIf="!hideDetailsLaterOption">
        <input type="checkbox" [(ngModel)]="fillDetailsLater" (click)="clearAllFields()">
        I will provide this information later
      </div>
    </div>
    <div *ngIf="!fillDetailsLater">
      <div class="section research-purpose-section">
        <div class="required-field section-header">
          <div class="section-header">Describe your research purpose</div>
          <div class="required-text">(Required)</div>
          <app-tooltip>
            <div class="tooltip-label">
              You  are required to describe your research purpose, or the reason why you are conducting this study. This information, along with your name,
              will be posted on the publicly available All of Us website (https://www.researchallofus.org/) to inform our participants
              and other stakeholders about what kind of research their data is being used for.
            </div>
          </app-tooltip>
        </div>
        <div class="section-text">
          Please include the <strong>research question</strong>, the <strong>plan for use of the data</strong> to answer
          the research question, and the <strong>expected outcome/benefit</strong> of the research; this
          information will be posted publicly on the All of Us website to inform the research
          participants.
        </div>
        <textarea class="input description" name="workspace-description"
            [(ngModel)]="workspace.description" [disabled]="!hasPermission"
            [class.validation-error]="descriptionNotEntered">
        </textarea>
      </div>
      <div class="section data-use-categories-section">
        <h4 class="section-header">Please select all data use categories that apply for your current study</h4>
        <div class="section-text">
          These are for informational purposes only and do not affect or configure your new workspace.
        </div>
        <div class="form-group">
          <div class="checkbox-group" style="margin-top: 0.5rem;">
            <div style="display: flex">
              <clr-checkbox
                  name="disease-focused-research"
                  id="disease-focused-research"
                  [(ngModel)]="workspace.researchPurpose.diseaseFocusedResearch">
              </clr-checkbox>
              <div>
                <label class="checkbox-label" for="clr-checkbox-disease-focused-research"><h3 class="data-use-label">
                  {{researchPurposeItems.diseaseFocusedResearch.shortDescription}}</h3>
                </label>
                <div>
                  {{researchPurposeItems.diseaseFocusedResearch.longDescription}}
                </div>
                <div style="display: flex">
                  <div role="tooltip" aria-haspopup="true" style="width: calc(50% - 2rem); margin-right: 2rem; margin-top: 0.5rem;" class="tooltip tooltip-md tooltip-right">
                    <input type="text" class="input" name="disease-specification"
                        [(ngModel)]="workspace.researchPurpose.diseaseOfFocus" placeholder="Name of Disease"
                           style="width: 100%"
                           [disabled]="!workspace.researchPurpose.diseaseFocusedResearch">
                    <span *ngIf="!workspace.researchPurpose.diseaseFocusedResearch" class="tooltip-content">You must select disease focused research to enter a disease of focus</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="checkbox-group">
              <div style="display: flex">
                <clr-checkbox
                    name="methods-development"
                    id="methods-development"
                    [(ngModel)]="workspace.researchPurpose.methodsDevelopment">
                </clr-checkbox>
                <div>
                  <label class="checkbox-label" for="clr-checkbox-methods-development"><h3 class="data-use-label">
                    {{researchPurposeItems.methodsDevelopment.shortDescription}}</h3></label>
                  <div>
                    {{researchPurposeItems.methodsDevelopment.longDescription}}
                  </div>
                </div>
              </div>
            </div>
            <div class="checkbox-group">
              <div style="display: flex">
                <clr-checkbox
                        name="aggregate-analysis"
                        id="aggregate-analysis"
                        [(ngModel)]="workspace.researchPurpose.aggregateAnalysis">
                </clr-checkbox>
                <div>
                  <label class="checkbox-label" for="clr-checkbox-aggregate-analysis"><h3 class="data-use-label">
                    {{researchPurposeItems.aggregateAnalysis.shortDescription}}</h3></label>
                  <div>
                    {{researchPurposeItems.aggregateAnalysis.longDescription}}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="checkbox-group">
              <div style="display: flex">
                <clr-checkbox
                    name="control-set"
                    id="control-set"
                    [(ngModel)]="workspace.researchPurpose.controlSet">
                </clr-checkbox>
                <div>
                  <label class="checkbox-label" for="clr-checkbox-control-set"><h3 class="data-use-label">
                    {{researchPurposeItems.controlSet.shortDescription}}</h3></label>
                  <div>
                    {{researchPurposeItems.controlSet.longDescription}}
                  </div>
                </div>
              </div>
            </div>
            <div class="checkbox-group">
              <div style="display: flex">
                <clr-checkbox
                        name="ancestry"
                        id="ancestry"
                        [(ngModel)]="workspace.researchPurpose.ancestry">
                </clr-checkbox>
                <div>
                  <label class="checkbox-label" for="clr-checkbox-ancestry"><h3 class="data-use-label">
                    {{researchPurposeItems.ancestry.shortDescription}}</h3></label>
                  <div>
                    {{researchPurposeItems.ancestry.longDescription}}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="checkbox-group">
              <div style="display: flex">
                <clr-checkbox
                        name="population"
                        id="population"
                        [(ngModel)]="workspace.researchPurpose.population">
                </clr-checkbox>
                <div>
                  <label class="checkbox-label" for="clr-checkbox-population"><h3 class="data-use-label">
                    {{researchPurposeItems.population.shortDescription}}</h3></label>
                  <div>
                    {{researchPurposeItems.population.longDescription}}
                  </div>
                </div>
              </div>
            </div>
            <div class="checkbox-group">
              <div style="display: flex">
                <clr-checkbox
                        name="commercial-purpose"
                        id="commercial-purpose"
                        [(ngModel)]="workspace.researchPurpose.commercialPurpose">
                </clr-checkbox>
                <div>
                  <label class="checkbox-label" for="clr-checkbox-commercial-purpose"><h3 class="data-use-label">
                    {{researchPurposeItems.commercialPurpose.shortDescription}}</h3></label>
                  <div>
                    {{researchPurposeItems.commercialPurpose.longDescription}}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="checkbox-group">
              <div style="display: flex">
                <div (click)="workspace.researchPurpose.containsUnderservedPopulation = !workspace.researchPurpose.containsUnderservedPopulation"
                    class="underserved-icon"
                    style="cursor: pointer; padding-right: 6px">
                  <clr-icon *ngIf="workspace.researchPurpose.containsUnderservedPopulation"
                      shape="minus-circle" class="underserved-icon"></clr-icon>
                  <clr-icon *ngIf="!workspace.researchPurpose.containsUnderservedPopulation"
                      shape="plus-circle" class="underserved-icon"></clr-icon>
                </div>
                <div>
                  <div style="display:flex; flex-direction: row">
                    <label class="checkbox-label"
                           (click)="workspace.researchPurpose.containsUnderservedPopulation = !workspace.researchPurpose.containsUnderservedPopulation">
                      <h3 class="data-use-label">
                        {{researchPurposeItems.containsUnderservedPopulation.shortDescription}}</h3></label>
                    <app-tooltip>
                      <div class="tooltip-label">
                        A primary mission of the All of Us Research Program is to include populations that are medically
                        underserved and/or historically underrepresented in biomedical research or who, because of systematic
                        social disadvantage, experience disparities in health. As a way to understand how much research is
                        being conducted on these populations, All of Us requests that you mark all options for underserved
                        populations that will be included in your research.
                      </div>
                    </app-tooltip>
                  </div>
                  <div>
                    {{researchPurposeItems.containsUnderservedPopulation.longDescription}}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="workspace.researchPurpose.containsUnderservedPopulation === true" style="padding-top: 1rem">
            <h5>Additional information for underserved population</h5>
            <div>Select all that apply. Only options for underserved populations are provided.</div>
            <div *ngFor="let categoryHeader of keys(underservedCategories)">
              <h4 class="underserved-header">{{categoryHeader}}</h4>
              <div class="underservedSection">
                <div *ngFor="let sublist of bucketAsThree(keys(underservedCategories[categoryHeader]));">
                  <div class="row flex-items-xs-left">
                    <div *ngFor="let item of sublist;" class="col-xs-4">
                      <clr-checkbox
                          [clrChecked]="containsUnderserved(underservedCategories[categoryHeader][item])"
                          (click)="switchUnderservedStatus(underservedCategories[categoryHeader][item])"
                          class="underserved-checkbox"
                          name="{{underservedCategories[categoryHeader][item]}}"
                          id="{{underservedCategories[categoryHeader][item]}}">
                        {{item}}
                      </clr-checkbox>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="section request-review-section">
      <div style="display: flex; flex-direction: row">
      <h3 class="section-header">{{researchPurposeItems.requestReview.shortDescription}}</h3>
      <app-tooltip direction="top-right">
        <div class="tooltip-label">
          If you are concerned that your research may be stigmatizing to a particular group of research participants,
          you may request a review of your research purpose by the All of Us Resource Access Board (RAB).
          The RAB will provide feedback regarding potential for stigmatizing specific groups of participants and,
          if needed, guidance for modifying your research purpose/scope. Even if you request a review,
          you will be able to create a Workspace and proceed with your research.
        </div>
      </app-tooltip>
      </div>
      <div class="checkbox-group" style="padding-top: 0.3rem">
        <div style="display: flex">
          <clr-checkbox
              name="request-approval"
              id="request-approval"
              [(ngModel)]="workspace.researchPurpose.reviewRequested">
          </clr-checkbox>
          <div>
            <div class="section-text">
              I am concerned about potential <a (click)="openStigmatizationLink()">stigmatization</a>
              of research participants. I would like the All of Us Resource Access Board (RAB) to
              review my Research Purpose. (This will not prevent you from creating a workspace and
              proceeding.)
            </div>
          </div>
        </div>
      </div>
    </div>
    <div style="display: flex; flex: 0 0 0; padding: 0">
      <div class="button">
        <button class="btn" (click)="navigateBack()">Cancel</button>
        <div class="tooltip">
          <div class="tooltip-content-wrapper">
            <ng-container [ngSwitch]="mode">
              <button *ngSwitchCase="Mode.Create" class="btn add-button btn-primary"
                  [clrLoading]="savingWorkspace" (click)="addWorkspace()" [disabled]="!allowSave">
                Create Workspace
              </button>
              <button *ngSwitchCase="Mode.Edit" class="btn add-button btn-primary"
                  [clrLoading]="savingWorkspace" (click)="updateWorkspace()"
                  [disabled]="!hasPermission || !allowSave">
                Update Workspace
              </button>
              <button *ngSwitchCase="Mode.Clone" class="btn add-button btn-primary"
                  [clrLoading]="savingWorkspace" (click)="cloneWorkspace()"
                  [disabled]="!allowSave">
                Duplicate Workspace
              </button>
            </ng-container>
            <div *ngIf="!isValidWorkspace" class="tooltip-text">
              <div *ngIf="missingFields else nameValidationError">
                Missing Required Fields:
                <ul>
                  <li *ngIf="isBlank(workspace.name)">Name</li>
                  <li *ngIf="isBlank(workspace.description)">Description</li>
                </ul>
              </div>
              <ng-template #nameValidationError>
                <div *ngIf="nameValidationError">
                  Name must be shorter than 80 characters
                </div>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- TODO: Factor out to component -->
<ng-template #notFoundMessage>
  <h3>
    Workspace {{oldWorkspaceNamespace}}/{{oldWorkspaceName}} could not be found.
  </h3>
</ng-template>
<clr-modal [(clrModalOpen)]="workspaceCreationError">
  <h3 class="modal-title">Error:</h3>
  <div class="modal-body">Could not create workspace.</div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="navigateBack()">Cancel Creation</button>
    <button type="button" class="btn btn-primary" (click)="resetWorkspaceEditor()">Keep Editing</button>
  </div>
</clr-modal>
<clr-modal [(clrModalOpen)]="workspaceCreationConflictError">
  <h3 class="modal-title">Error:</h3>
  <div class="modal-body">You already have a workspace named {{workspace.name}}. Please choose another name.</div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="navigateBack()">Cancel Creation</button>
    <button type="button" class="btn btn-primary" (click)="resetWorkspaceEditor()">Keep Editing</button>
  </div>
</clr-modal>
<clr-modal [(clrModalOpen)]="workspaceUpdateError">
  <h3 class="modal-title">Error:</h3>
  <div class="modal-body">Could not update workspace.</div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="navigateBack()">Cancel Edits</button>
    <button type="button" class="btn btn-primary" (click)="resetWorkspaceEditor()">Keep Editing</button>
  </div>
</clr-modal>
<clr-modal [(clrModalOpen)]="workspaceUpdateConflictError">
  <h3 class="modal-title">Conflicting update:</h3>
  <div class="modal-body">
    Another client has modified this workspace since the beginning of this
    editing session. Please reload to avoid overwriting those changes.
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="reloadConflictingWorkspace()">Reload Workspace</button>
    <button type="button" class="btn btn-primary" (click)="resetWorkspaceEditor()">Keep Editing</button>
  </div>
</clr-modal>
