{
  "name": "All of Us Dataset Builder R snippets",
  "sub-menu": [
    {
      "name": "Documentation",
      "external-link": "https://github.com/all-of-us/workbench-snippets"
    },
    "---",
    {
      "name": "(1) Setup",
      "snippet": "lapply(c('viridis', 'ggthemes', 'skimr'),\n       function(pkg_name) { if(! pkg_name %in% installed.packages()) { install.packages(pkg_name)} } )\n\nlibrary(viridis)    # A nice color scheme for plots.\nlibrary(ggthemes)   # Common themes to change the look and feel of plots.\nlibrary(scales)     # Graphical scales map data to aesthetics in plots.\nlibrary(skimr)      # Better summaries of data.\nlibrary(lubridate)  # Date library from the tidyverse.\nlibrary(tidyverse)  # Data wrangling packages.\n\n## Plot setup.\ntheme_set(theme_bw(base_size = 14)) # Default theme for plots.\n\n#' Returns a data frame with a y position and a label, for use annotating ggplot boxplots.\n#'\n#' @param d A data frame.\n#' @return A data frame with column y as max and column label as length.\nget_boxplot_fun_data <- function(df) {\n  return(data.frame(y = max(df), label = stringr::str_c('N = ', length(df))))\n}\n"
    },
    {
      "name": "(2) Basic operations",
      "sub-menu": [
        {
          "name": "join_dataframes.R",
          "snippet": "# Use snippet 'join_dataframes' to join together two dataframes.\n# It assumes the 'Setup' snippet has been executed.\n#\n# In the example below, it joins Demographics '_person_df' and Measurements '_measurement_df' using\n# any columns they have in common, which in this case should only be 'person_id'.\n#\n# See also https://dplyr.tidyverse.org/reference/join.html and https://r4ds.had.co.nz/relational-data.html#understanding-joins\n\n\n## -----[ CHANGE THE DATAFRAME NAME(S) TO MATCH YOURS FROM DATASET BUILDER] -----\nmeasurement_df <- inner_join(YOUR_DATASET_NAME_person_df,\n                             YOUR_DATASET_NAME_measurement_df) %>%\n  mutate_if(is.list, as.character)  # Convert column type list as character.\n\ndim(measurement_df)\n"
        },
        {
          "name": "summarize_a_dataframe.R",
          "snippet": "# Use snippet 'summarize_a_dataframe' to display summary statistics for a dataframe.\n# It assumes snippet 'Setup' has been executed.\n# See also https://www.rdocumentation.org/packages/skimr/versions/1.0.7/topics/skim\n\n\n## -----[ CHANGE THE DATAFRAME NAME(S) TO MATCH YOURS FROM DATASET BUILDER] -----\nprint(skim(YOUR_DATASET_NAME_person_df))\n"
        },
        {
          "name": "add_age_to_demographics.R",
          "snippet": "# Use snippet 'add_age_to_demographics' to calculate the age of people in your demographics.\n# It assumes the 'Setup' snippet has been executed.\n# It also assumes that you got your demographics dataframe from Dataset Builder\n\n# Note: This snippet calculates current age and does not take into account whether the person is already dead\n\n\n## -----[ CHANGE THE DATAFRAME NAME(S) `YOUR_DATASET_NAME_person_df` TO MATCH YOURS FROM DATASET BUILDER] -----\nYOUR_DATASET_NAME_person_df <- YOUR_DATASET_NAME_person_df %>%\n                mutate_if(is.list, as.character) %>% \n                mutate(AGE = year(today()) - year(YOUR_DATASET_NAME_person_df$DATE_OF_BIRTH))\n"
        }
      ]
    },
    {
      "name": "(3) Plot measurements",
      "sub-menu": [
        {
          "name": "measurement_by_age_and_gender.ggplot",
          "snippet": "# Use snippet 'measurement_by_age_and_gender' to plot joined demographics and measurements dataframes.\n# This plot assumes 'measurement_df' was created using snippet 'Basic operations -> join_dataframes' to\n# join together demographics and measurements dataframes.\n# See also https://r4ds.had.co.nz/data-visualisation.html\n\n\noptions(repr.plot.height = 16, repr.plot.width = 16)\n\n# There could be many different measurements in the dataframe. By default, plot the first one.\nmeasurement_to_plot <- unique(measurement_df$STANDARD_CONCEPT_NAME)[1]\n\nmeasurement_df %>%\n    filter(STANDARD_CONCEPT_NAME == measurement_to_plot) %>%\n    filter(!UNIT_CONCEPT_NAME %in% c('No matching concept', 'NULL')) %>%\n    filter(GENDER != 'No matching concept') %>%\n    filter(VALUE_AS_NUMBER < 9999999) %>%  # Get rid of nonsensical outliers.\n    mutate(age_at_measurement = year(as.period(interval(start = DATE_OF_BIRTH, end = MEASUREMENT_DATETIME)))) %>%\n    ggplot(aes(x = cut_width(age_at_measurement, width = 5, boundary = 0), y = VALUE_AS_NUMBER)) +\n    geom_boxplot() +\n    stat_summary(fun.data = get_boxplot_fun_data, geom = 'text', size = 2,\n                 position = position_dodge(width = 0.9), vjust = -0.8) +\n#    scale_y_log10() +  # Uncomment if the data looks skewed.\n    coord_flip() +\n    facet_wrap(STANDARD_CONCEPT_NAME + UNIT_CONCEPT_NAME ~ GENDER, ncol = 2, scales = 'free') +\n    xlab('age group') +\n    labs(title = str_glue('Numeric values of measurements by age and gender'), caption = 'Source: All Of Us Data')\n"
        },
        {
          "name": "measurement_by_gender.ggplot",
          "snippet": "# Use snippet 'measurement_by_gender' to plot joined demographics and measurements dataframes.\n# This plot assumes 'measurement_df' was created using snippet 'Basic operations -> join_dataframes' to\n# join together demographics and measurements dataframes.\n# See also https://r4ds.had.co.nz/data-visualisation.html\n\n\noptions(repr.plot.height = 10, repr.plot.width = 16)\n\n# There could be many different measurements in the dataframe. By default, plot the first one.\nmeasurement_to_plot <- unique(measurement_df$STANDARD_CONCEPT_NAME)[1]\n\nmeasurement_df %>%\n    filter(STANDARD_CONCEPT_NAME == measurement_to_plot) %>%\n    filter(!UNIT_CONCEPT_NAME %in% c('No matching concept', 'NULL')) %>%\n    filter(VALUE_AS_NUMBER < 9999999) %>%  # Get rid of nonsensical outliers.\n    ggplot(aes(x = GENDER, y = VALUE_AS_NUMBER)) +\n    geom_boxplot() +\n    stat_summary(fun.data = get_boxplot_fun_data, geom = 'text', size = 4,\n                 position = position_dodge(width = 0.9), vjust = -0.8) +\n#    scale_y_log10() +  # Uncomment if the data looks skewed.\n    facet_wrap(STANDARD_CONCEPT_NAME ~ UNIT_CONCEPT_NAME, ncol = 2, scales = 'free') +\n    labs(title = str_glue('Numeric values of measurements, by gender'), caption = 'Source: All Of Us Data') +\n    theme(axis.text.x = element_text(angle=25, hjust=1))\n"
        }
      ]
    }
  ]
}
