#!/usr/bin/env ruby

require 'fileutils'
require_relative "../../aou-utils/workbench"
require_relative "../../aou-utils/utils/common"

def build_snippets_menu()
  tmpl = File.read("aou-snippets-menu.js.template")
  tmpl = "/* " + ("=" * 20) +
         " This file is autogenerated, DO NOT MODIFY MANUALLY " +
         ("=" * 20) + " */\n" + tmpl

  {
    "{{PY_DATASET_MENU_JSON}}" => "py-dataset-snippets-menu.json",
    "{{PY_GCS_MENU_JSON}}" => "py-gcs-snippets-menu.json",
    "{{PY_SQL_MENU_JSON}}" => "py-sql-snippets-menu.json",
    "{{PY_CROMWELL_JSON}}" => "py-cromwell-snippets-menu.json",
    "{{R_CROMWELL_JSON}}" => "r-cromwell-snippets-menu.json",
    "{{R_DATASET_MENU_JSON}}" => "r-dataset-snippets-menu.json",
    "{{R_GCS_MENU_JSON}}" => "r-gcs-snippets-menu.json",
    "{{R_SQL_MENU_JSON}}" => "r-sql-snippets-menu.json",
  }.each do |var, path|
    # Ruby apparently lacks a basic string replacement function. sub/gsub
    # support pattern inputs and captures, and \ interacts poorly with output
    # captures. Replace manually.
    i = tmpl.index(var)
    tmpl.sub! var, ''
    tmpl = tmpl.insert i, File.read(path)
  end

  out = "../src/main/webapp/static/aou-snippets-menu.js"
  File.write(out, tmpl)
  Common.new.status "Wrote generated menu to GAE static dir: #{out}"
end

Common.register_command({
  :invocation => "build-snippets-menu",
  :description => "Builds the templated snippets menu Jupyter extension",
  :fn => ->() { build_snippets_menu }
})

Workbench.handle_argv_or_die(__FILE__)
