<div class="survey-view">

  <div class="row">

    <div class="col-xs-12">
      <div class="page-header">
        <div *ngIf="survey && survey.conceptId">
          <h2> {{survey.name}} Survey </h2>
          <h4 class="view-sub-title">{{survey.description}} </h4>
        </div>
      </div>
    </div>

  </div>

  <div class="row">

    <div class="col-md-4 col-sm-6 col-xs-12">
      <div class="white-card-box top-stat">
        <div class="row ">
          <div class="col-xs-12">
            <h5 class="box-title">
              Number Completed
            </h5>
            <div class="card-stat" *ngIf="!loading">
              {{survey.participantCount | number }}
            </div>
            <div class="card-text">
              partipants completed this survey
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4 col-sm-6 col-xs-12">
      <div class="white-card-box top-stat">
        <div class="row ">
          <div class="col-xs-12">
            <h5 class="box-title">
              Questions
            </h5>
            <div class="card-stat">
              <span *ngIf="loading" class="spinner spinner-md"> </span>
              <span *ngIf="!loading" >{{ surveyResult.items.length }} </span>
            </div>
            <div class="card-text">
              <a href="{{surveyPdfUrl}}" download> Download Survey PDF <clr-icon shape="file" class="has-badge is-solid"></clr-icon></a>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Todo show general totals for demographics of who took the survey -->
  <!--
  <div class="row">
    <div class="col-xs-12">
      <app-concept-charts [concept]="survey" [showRace]="true" [showAge]="true" [showGender]="true"
                        [showEthnicity]="true" [backgroundColor]="'#ECF1F4'">
      </app-concept-charts>
    </div>
  </div>
  -->

  <div class="survey-results" *ngIf="resultsComplete">

    <div class="row search">
      <div class="col-xs-12 flex-xs-middle search-input-full ">
        <div class="search-wrapper">
          <clr-icon shape="search" class="input-icon-absolute is-info"></clr-icon>
          <input type="text" id="search-db" placeholder="Keyword Search" [formControl]="searchText" autofocus>
        </div>
      </div>
    </div>

    <div class="row box-sub-title">
      <div *ngIf="loading" class="col-xs-12 flex">
        <span *ngIf="loading" class="spinner spinner-md"> </span>
      </div>
      <div class="col-xs-12 flex" *ngIf="searchText.value.length > 0">
        <p class="results-heading no-results" *ngIf="questions.length === 0 && !loading">
          <span *ngIf="searchMethod === 'and'"> No questions match *ALL* keywords: <mark> {{searchText.value}}</mark>.
            <span  class="search-extra"> <button class="btn btn-link" (click)="setSearchMethod('or')">Match any keyword</button> </span>
          </span>
          <span *ngIf="searchMethod === 'or'"> No questions match any of the keywords: <mark> {{searchText.value}}</mark>.
            <span  class="search-extra"> <button class="btn btn-link" (click)="setSearchMethod('or', true)">Reset search</button></span>
          </span>
        </p>
        <p class="results-heading" *ngIf="questions.length > 0 && !loading">
          <span *ngIf="searchMethod==='or'" >
            <b> {{questions.length}} </b> questions match <b>*ANY*</b> keyword: <mark>{{searchText.value}}</mark>.
            <button class="btn btn-link" (click)="setSearchMethod('and')">Match all keywords</button>
          </span>
          <span *ngIf="searchMethod==='and'" >
            <span> <b> {{questions.length}} </b> questions match <b>*ALL*</b> keywords: <mark>{{searchText.value}}</mark>.</span>
            <button class="btn btn-link" (click)="setSearchMethod('or')">Match any keyword</button>
          </span>
        </p>
      </div>
      <div class="col-xs-12">
      Click on each response to view age and gender distributions.
      </div>
    </div>
    <div class="row question-result" *ngFor="let q of questions, let i = index">

      <div class=" question-card">

        <div class="row question">

          <div class="col-xs-12 col-sm-12">
            <div class="box-title"> Question {{i + 1}}</div>
            <div class="box-sub-title question-display">
              <div class="box-sub-title question question">
                <app-highlight-search [text]="q.conceptName" [searchTerm]="searchText.value" [conceptId]="q.conceptId"></app-highlight-search>
              </div>
              <clr-tooltip>
                <clr-icon clrTooltipTrigger shape="info-standard" class="info-icon"></clr-icon>
                <clr-tooltip-content clrPosition=bottom-left
                                     clrSize="lg" *clrIfOpen>
                  <div class="tooltip-label">The concept code is an additional piece of information that
                    can be utilized to find medical concepts in the AoU data set. Concept codes are specific to the
                    AoU Research Program data and are assigned to all medical concepts.
                    In some instances,
                    a medical concept may not be assigned a source or standard vocabulary code.
                    In these instances, the concept code can be utilized to
                    query the data for the medical concept.</div>
                </clr-tooltip-content>
              </clr-tooltip>
            </div>
          </div>
        </div>

        <div class="row">
            <div class="col-xs-12">
              <a class="toggle-link" (click)="toggleAnswer(q.conceptId)"> See Answers - Click on each response option for additional gender and age at occurrence data.
                <clr-icon *ngIf="!showAnswer[q.conceptId]" shape="caret" dir="right"></clr-icon> <clr-icon *ngIf="showAnswer[q.conceptId]" shape="caret" dir="down"></clr-icon> </a>
            </div>
        </div>

        <div class="row  answers" [hidden]="!showAnswer[q.conceptId]">
          <div class="col-md-7 col-sm-5 col-xs-12 answer-list">
            <div  class="row answer-text"  [class.answer-active]="q.selectedAnswer && q.selectedAnswer.id === a.id" (click)="showAnswerGraphs(q, a)" *ngFor="let a of q.countAnalysis.results">
              <div class="col-sm-6 col-xs-12" *ngIf="!binnedSurveyQuestions.includes(a.stratum2); else binnedSurveyQuestionDisplay">
                <label class="answer-text">
                  <app-highlight-search [text]="a.stratum4" [searchTerm]="searchText.value" [conceptId]="a.stratum3"></app-highlight-search>
                </label>
              </div>
              <ng-template #binnedSurveyQuestionDisplay>
                <div class="col-sm-6 col-xs-12">
                  <label class="answer-text" *ngIf="a.stratum4.toLowerCase().trim() === 'did not answer'; else rangeLabel">
                    <app-highlight-search [text]="a.stratum4" [searchTerm]="searchText.value" [conceptId]="a.stratum3"></app-highlight-search>
                  </label>
                  <ng-template #rangeLabel>
                    <label class="answer-text">
                      <app-highlight-search [text]="a.stratum4 + '-' + (convertToNum(a.stratum4)+10)" [searchTerm]="searchText.value" [conceptId]="a.stratum3"></app-highlight-search>
                    </label>
                  </ng-template>
                </div>
              </ng-template>
              <div class="answer-text col-sm-2 col-xs-12"  [class.answer-active]="q.selectedAnswer && q.selectedAnswer.id === a.id">
                <label class="participant-count answer-text">{{a.countValue | number}}  </label>
              </div>
              <div class="col-sm-4 col-xs-12 percent-bar"  [class.answer-active]="q.selectedAnswer && q.selectedAnswer.id === a.id">
                <div class="progress labeled">
                  <progress max="100" value="{{a.countPercent}}" data-displayval="0%"></progress>
                  <span>{{a.countPercent.toFixed(2)}}%</span>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-5 col-sm-7 col-xs-12 answer-charts">
            <div class="row answer-charts-wrapper flex-items-xs-middle" *ngIf="q.selectedAnswer && q.selectedAnswer.stratum4.toLowerCase() != 'did not answer' " >
              <clr-tooltip>
                <clr-icon clrTooltipTrigger shape="info-standard" class="info-icon"></clr-icon>
                <clr-tooltip-content clrPosition=right
                                     clrSize="lg" *clrIfOpen>
                  <div class="tooltip-label">Gender chart</div>
                </clr-tooltip-content>
              </clr-tooltip>
              <div class="chart-wrapper col-xs-12 col-sm-12">
                <div class="col-md gender-chart-button">
                  <button *ngFor="let g of ['Biological Sex','Gender Identity']" [ngClass]="{active:selectedGenderGraph === g}" (click)="selectSurveyGenderGraph(g)" class="btn btn-link">{{g}}
                  </button>
                  <clr-tooltip>
                    <clr-icon clrTooltipTrigger shape="info-standard" class="info-icon"></clr-icon>
                    <clr-tooltip-content clrPosition=right
                                         clrSize="lg" *clrIfOpen>
                      <div class="tooltip-label">Toggle here to view biological sex / gender identity chart</div>
                    </clr-tooltip-content>
                  </clr-tooltip>
                </div>
                <app-chart [analysis]="genderGraph === 'GI' ? q.genderIdentityAnalysis : q.genderAnalysis" [selectedResult]="q.selectedAnswer" [backgroundColor]="'#D9E4EA'"></app-chart>
              </div>
              <clr-tooltip>
                <clr-icon clrTooltipTrigger shape="info-standard" class="info-icon"></clr-icon>
                <clr-tooltip-content clrPosition=right
                                     clrSize="lg" *clrIfOpen>
                  <div class="tooltip-label">The age at occurrence bar chart provides a binned age distribution for
                    participants at the time the medical concept being queried occurred in their records.
                    If an individualâ€™s record contains more than one mention of a concept,
                    the age at occurrence is included for each mention.
                    As a result, a participant may be counted more than once in the distribution.
                  </div>
                </clr-tooltip-content>
              </clr-tooltip>
              <div class="chart-wrapper age col-xs-12 col-sm-12">
                <app-chart [analysis]="q.ageAnalysis" [selectedResult]="q.selectedAnswer" [pointWidth]="20" [backgroundColor]="'#D9E4EA'"></app-chart>
              </div>

            </div>
          </div>
        </div> <!-- end collapsible answers -->

      </div>

    </div>

  </div>

</div>
